apiVersion: batch/v1
kind: Job
metadata:
  name: cloud-sql-restore-ojeomneo
  namespace: ojeomneo
  labels:
    app: cloud-sql-restore
    database: ojeomneo
spec:
  ttlSecondsAfterFinished: 3600  # 1시간 후 자동 삭제
  backoffLimit: 3  # 최대 3번 재시도
  template:
    metadata:
      labels:
        app: cloud-sql-restore
        database: ojeomneo
    spec:
      serviceAccountName: cloud-sql-restore-sa
      restartPolicy: Never

      initContainers:
        # GCS에서 SQL 백업 파일 다운로드
        - name: download-backup
          image: google/cloud-sdk:alpine
          command:
            - sh
            - -c
            - |
              set -e
              echo "=== Downloading SQL backup from GCS ==="
              gsutil cp gs://woohalabs-database-backups/backups/ojeomneo_backup.sql /backup/ojeomneo_backup.sql
              echo "=== Download completed ==="
              ls -lh /backup/
          volumeMounts:
            - name: backup-volume
              mountPath: /backup

      containers:
        # PostgreSQL 데이터 복원
        - name: restore-database
          image: postgres:15-alpine
          command:
            - sh
            - -c
            - |
              set -e

              echo "=== Starting database restore ==="
              echo "Database: $POSTGRES_DB"
              echo "Host: $POSTGRES_HOST"
              echo "Port: $POSTGRES_PORT"
              echo "User: $POSTGRES_USER"

              # 연결 테스트
              echo "=== Testing database connection ==="
              PGPASSWORD=$POSTGRES_PASSWORD psql \
                -h $POSTGRES_HOST \
                -p $POSTGRES_PORT \
                -U $POSTGRES_USER \
                -d $POSTGRES_DB \
                -c "SELECT version();"

              if [ $? -ne 0 ]; then
                echo "ERROR: Failed to connect to database"
                exit 1
              fi

              echo "=== Connection successful ==="

              # 데이터베이스 복원 (트랜잭션 내에서 실행)
              echo "=== Restoring database from backup ==="
              PGPASSWORD=$POSTGRES_PASSWORD psql \
                -h $POSTGRES_HOST \
                -p $POSTGRES_PORT \
                -U $POSTGRES_USER \
                -d $POSTGRES_DB \
                -f /backup/ojeomneo_backup.sql

              if [ $? -ne 0 ]; then
                echo "ERROR: Database restore failed"
                exit 1
              fi

              echo "=== Database restore completed successfully ==="

              # 복원 후 검증
              echo "=== Verifying restored data ==="
              PGPASSWORD=$POSTGRES_PASSWORD psql \
                -h $POSTGRES_HOST \
                -p $POSTGRES_PORT \
                -U $POSTGRES_USER \
                -d $POSTGRES_DB \
                -c "\dt"

              echo "=== Restore job finished ==="
          env:
            - name: POSTGRES_HOST
              valueFrom:
                secretKeyRef:
                  name: ojeomneo-db-credentials
                  key: POSTGRES_HOST
            - name: POSTGRES_PORT
              valueFrom:
                secretKeyRef:
                  name: ojeomneo-db-credentials
                  key: POSTGRES_PORT
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: ojeomneo-db-credentials
                  key: POSTGRES_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: ojeomneo-db-credentials
                  key: POSTGRES_PASSWORD
            - name: POSTGRES_DB
              valueFrom:
                secretKeyRef:
                  name: ojeomneo-db-credentials
                  key: POSTGRES_DB
          volumeMounts:
            - name: backup-volume
              mountPath: /backup
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi

      volumes:
        - name: backup-volume
          emptyDir: {}
