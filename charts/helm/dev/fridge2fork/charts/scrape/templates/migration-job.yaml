{{- if .Values.migration.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "scrape.fullname" . }}-fix-migration
  labels:
    {{- include "scrape.labels" . | nindent 4 }}
    app.kubernetes.io/component: migration
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: fix-migration
        image: ggorockee/fridge2fork-dev-scrape:sha-1b57413b
        command:
          - /bin/sh
          - -c
          - |
            cd /app
            export DATABASE_URL="postgresql://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/${DB_NAME}"

            # 강제로 마이그레이션 파일 생성
            alembic revision --autogenerate -m "Create recipes tables"
            alembic upgrade head

            # 결과 확인
            python -c "
            import os, asyncio, asyncpg
            async def check():
                conn = await asyncpg.connect(os.environ['DATABASE_URL'])
                result = await conn.fetch('SELECT table_name FROM information_schema.tables WHERE table_schema = \\'public\\'')
                print([row['table_name'] for row in result])
                await conn.close()
            asyncio.run(check())
            "
        envFrom:
          {{- toYaml .Values.envFrom | nindent 10 }}
{{- end }}