#########################################################################
# Ojeomneo (오점너) Helm Chart Values
# Go Fiber v2 API Server + PostgreSQL
#########################################################################

#########################################################################
# Server 설정 (Go Fiber v2 API)
#########################################################################
server:
  enabled: true
  replicaCount: 1
  revisionHistoryLimit: 1

  image:
    repository: ggorockee/ojeomneo-server-with-go
    pullPolicy: IfNotPresent
    tag: "20251220-c37ad76"

  imagePullSecrets: []
  nameOverride: ""
  fullnameOverride: ""

  serviceAccount:
    create: true
    automount: true
    annotations: {}
    name: ""

  podAnnotations: {}
  podLabels:
    app: "ojeomneo-server"
    job: "ojeomneo-server"

  podSecurityContext: {}
  securityContext: {}

  service:
    type: ClusterIP
    port: 3000
    portName: "fiber"

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi

  # Health check probes - Go Fiber healthcheck endpoint
  # /ojeomneo/v1/healthcheck/live  - K8s startup/liveness probe (항상 200)
  # /ojeomneo/v1/healthcheck/ready - K8s readiness probe (DB 체크)
  livenessProbe:
    httpGet:
      path: /ojeomneo/v1/healthcheck/live
      port: fiber
      scheme: HTTP
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  readinessProbe:
    httpGet:
      path: /ojeomneo/v1/healthcheck/ready
      port: fiber
      scheme: HTTP
    initialDelaySeconds: 5
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  startupProbe:
    httpGet:
      path: /ojeomneo/v1/healthcheck/live
      port: fiber
      scheme: HTTP
    initialDelaySeconds: 0
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 12

  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 3
    targetCPUUtilizationPercentage: 80

  volumes: []
  volumeMounts: []
  nodeSelector: {}
  tolerations: []
  affinity: {}

  configMap:
    enabled: true
    name: ""
    data:
      # 애플리케이션 기본 설정
      APP_ENV: "production"
      APP_PORT: "3000"

      # 데이터베이스 설정 (기본값)
      POSTGRES_PORT: "5432"

      # Redis 연결 설정 (기본값)
      REDIS_HOST: "ojeomneo-redis-master"
      REDIS_PORT: "6379"

      # Gemini LLM 설정 (기본값)
      GEMINI_MODEL: "gemini-2.0-flash"

      # OpenTelemetry 설정 (OpenTelemetry Collector 사용)
      OTEL_EXPORTER_OTLP_ENDPOINT: "otel-collector.monitoring.svc.cluster.local:4317"

      # JWT 토큰 설정 (기본값)
      JWT_ACCESS_TOKEN_EXPIRE_MINUTES: "15"
      JWT_REFRESH_TOKEN_EXPIRE_DAYS: "7"

      # SNS 로그인 설정 - Apple (기본값)
      APPLE_CLIENT_ID: "com.woohalabs.ojeomneo"

      # 기타 설정
      # 메뉴 시드 데이터 (없는 메뉴만 추가, 기존 데이터 유지)
      SEED_DATA: "true"

  secret:
    enabled: true
    names:
      - ojeomneo-db-credentials
      - ojeomneo-api-credentials

  # Prometheus Metrics 설정
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true  # Enabled - Prometheus ServiceMonitor for /ojeomneo/metrics
      interval: 30s
      scrapeTimeout: 10s

#########################################################################
# Database 설정 - Cloud SQL 사용으로 비활성화
# ExternalSecret을 통해 Secret Manager에서 연결 정보 자동 동기화
#########################################################################
database:
  enabled: false  # Using Cloud SQL instead of subchart database
  replicaCount: 1

  image:
    repository: postgres
    tag: "15.15-alpine3.22"
    pullPolicy: IfNotPresent

  imagePullSecrets: []
  nameOverride: ""
  fullnameOverride: ""

  podAnnotations: {}
  podLabels:
    app: "ojeomneo-database"

  podSecurityContext:
    fsGroup: 999

  securityContext:
    runAsUser: 999
    runAsGroup: 999

  postgresql:
    database: ojeomneo
    existingSecret: ojeomneo-db-credentials
    secretKeys:
      username: POSTGRES_USER
      password: POSTGRES_PASSWORD

  service:
    type: ClusterIP
    port: 5432

  persistence:
    enabled: true
    accessModes:
      - ReadWriteOnce
    size: 10Gi
    storageClass: ""

  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  livenessProbe:
    exec:
      command:
        - /bin/sh
        - -c
        - exec pg_isready -U $POSTGRES_USER -d $POSTGRES_DB -h 127.0.0.1 -p 5432
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 6

  readinessProbe:
    exec:
      command:
        - /bin/sh
        - -c
        - exec pg_isready -U $POSTGRES_USER -d $POSTGRES_DB -h 127.0.0.1 -p 5432
    initialDelaySeconds: 5
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 6

  nodeSelector: {}
  tolerations: []
  affinity: {}

#########################################################################
# Admin 설정 (Django Admin)
#########################################################################
admin:
  enabled: true
  replicaCount: 1
  revisionHistoryLimit: 1

  image:
    repository: ggorockee/ojeomneo-admin
    pullPolicy: IfNotPresent
    tag: "20251220-c0aee9a"

  imagePullSecrets: []
  nameOverride: ""
  fullnameOverride: ""

  serviceAccount:
    create: true
    automount: true
    annotations: {}
    name: ""

  podAnnotations: {}
  podLabels:
    app: "ojeomneo-admin"

  podSecurityContext: {}
  securityContext: {}

  service:
    type: ClusterIP
    port: 8000
    portName: "gunicorn"

  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi

  # Health check probes - Django Admin
  # /ojeomneo/v1/healthcheck/live/  - K8s startup/liveness probe (항상 200)
  # /ojeomneo/v1/healthcheck/ready/ - K8s readiness probe (DB 체크)
  livenessProbe:
    httpGet:
      path: /ojeomneo/v1/healthcheck/live/
      port: gunicorn
      scheme: HTTP
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  readinessProbe:
    httpGet:
      path: /ojeomneo/v1/healthcheck/ready/
      port: gunicorn
      scheme: HTTP
    initialDelaySeconds: 5
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  startupProbe:
    httpGet:
      path: /ojeomneo/v1/healthcheck/live/
      port: gunicorn
      scheme: HTTP
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 10
    failureThreshold: 18

  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 3
    targetCPUUtilizationPercentage: 80

  volumes: []
  volumeMounts: []
  nodeSelector: {}
  tolerations: []
  affinity: {}

  configMap:
    enabled: true
    name: ""
    data:
      DJANGO_DEBUG: "False"
      # Redis 연결 설정
      REDIS_HOST: "ojeomneo-redis-master"
      REDIS_PORT: "6379"
      # Server API URL (이미지 업로드용) - K8s 내부 서비스 호출
      SERVER_API_URL: "http://ojeomneo-server:3000/ojeomneo/v1"

  secret:
    enabled: true
    names:
      - ojeomneo-admin-credentials
      - ojeomneo-db-credentials

#########################################################################
# Web 설정 (Next.js Web Application)
#########################################################################
web:
  enabled: true
  replicaCount: 1
  revisionHistoryLimit: 1

  image:
    repository: ggorockee/ojeomneo-web
    pullPolicy: IfNotPresent
    tag: "20251224-b3ca16d"

  imagePullSecrets: []
  nameOverride: ""
  fullnameOverride: ""

  serviceAccount:
    create: true
    automount: true
    annotations: {}
    name: ""

  podAnnotations: {}
  podLabels:
    app: "ojeomneo-web"

  podSecurityContext: {}
  securityContext: {}

  service:
    type: ClusterIP
    port: 3000
    portName: "http"

  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi

  # Health check probes - Next.js Web
  livenessProbe:
    httpGet:
      path: /ojeomneo
      port: http
      scheme: HTTP
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  readinessProbe:
    httpGet:
      path: /ojeomneo
      port: http
      scheme: HTTP
    initialDelaySeconds: 5
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  startupProbe:
    httpGet:
      path: /ojeomneo
      port: http
      scheme: HTTP
    initialDelaySeconds: 0
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 12

  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 3
    targetCPUUtilizationPercentage: 80

  volumes: []
  volumeMounts: []
  nodeSelector: {}
  tolerations: []
  affinity: {}

  configMap:
    enabled: true
    name: ""
    data:
      NODE_ENV: "production"
      PORT: "3000"
      # Server API URL (클라이언트 사이드 요청용)
      NEXT_PUBLIC_API_URL: "https://api.woohalabs.com/ojeomneo/v1"

  secret:
    enabled: false
    names: []

#########################################################################
# Redis 설정 (Bitnami Redis)
# Disabled - 개발 환경에서만 사용, 프로덕션에서는 비활성화
#########################################################################
redis:
  enabled: true

  # 아키텍처: standalone (단일 인스턴스)
  architecture: standalone

  # 이미지 설정 (Bitnami 2025.08 이후 latest 태그만 지원)
  image:
    registry: docker.io
    repository: bitnami/redis
    tag: latest

  # 인증 설정
  auth:
    enabled: true
    existingSecret: "ojeomneo-redis-credentials"
    existingSecretPasswordKey: "redis-password"

  # 공통 Redis 설정
  commonConfiguration: |-
    maxmemory 200mb
    maxmemory-policy allkeys-lru

  # Master 설정
  master:
    count: 1
    persistence:
      enabled: true
      size: 1Gi
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 250m
        memory: 256Mi

  # Replica 비활성화 (standalone 모드)
  replica:
    replicaCount: 0
    persistence:
      enabled: false
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 250m
        memory: 256Mi

  # Metrics (Prometheus)
  metrics:
    enabled: true
    image:
      registry: docker.io
      repository: bitnami/redis-exporter
      tag: latest
    serviceMonitor:
      enabled: false  # Disabled - Prometheus Operator not installed
      namespace: ""
      interval: 30s
    resources:
      requests:
        cpu: 10m
        memory: 32Mi
      limits:
        cpu: 50m
        memory: 64Mi
