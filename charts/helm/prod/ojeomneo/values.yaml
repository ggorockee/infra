#########################################################################
# Ojeomneo (오점너) Helm Chart Values
# Go Fiber v2 API Server + PostgreSQL
#########################################################################

#########################################################################
# Server 설정 (Go Fiber v2 API)
#########################################################################
server:
  enabled: true
  replicaCount: 1
  revisionHistoryLimit: 1

  image:
    repository: ggorockee/ojeomneo-server-with-go
    pullPolicy: IfNotPresent
    tag: "20251203-be54907"

  imagePullSecrets: []
  nameOverride: ""
  fullnameOverride: ""

  serviceAccount:
    create: true
    automount: true
    annotations: {}
    name: ""

  podAnnotations: {}
  podLabels:
    app: "ojeomneo-server"
    job: "ojeomneo-server"

  podSecurityContext: {}
  securityContext: {}

  service:
    type: ClusterIP
    port: 3000
    portName: "fiber"

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi

  # Health check probes - Go Fiber healthcheck endpoint
  # /ojeomneo/v1/healthcheck/live  - K8s startup/liveness probe (항상 200)
  # /ojeomneo/v1/healthcheck/ready - K8s readiness probe (DB 체크)
  livenessProbe:
    httpGet:
      path: /ojeomneo/v1/healthcheck/live
      port: fiber
      scheme: HTTP
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  readinessProbe:
    httpGet:
      path: /ojeomneo/v1/healthcheck/ready
      port: fiber
      scheme: HTTP
    initialDelaySeconds: 5
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  startupProbe:
    httpGet:
      path: /ojeomneo/v1/healthcheck/live
      port: fiber
      scheme: HTTP
    initialDelaySeconds: 0
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 12

  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 3
    targetCPUUtilizationPercentage: 80

  volumes: []
  volumeMounts: []
  nodeSelector: {}
  tolerations: []
  affinity: {}

  configMap:
    enabled: true
    name: ""
    data:
      APP_ENV: "production"
      APP_PORT: "3000"
      # Redis 연결 설정
      REDIS_HOST: "ojeomneo-redis-master"
      REDIS_PORT: "6379"
      # 메뉴 시드 데이터 (없는 메뉴만 추가, 기존 데이터 유지)
      SEED_DATA: "true"
      # OpenTelemetry 설정 (SigNoz 연동)
      OTEL_EXPORTER_OTLP_ENDPOINT: "signoz-otel-collector.monitoring:4317"

  secret:
    enabled: true
    names:
      - ojeomneo-db-credentials
      - ojeomneo-api-credentials
      - ojeomneo-redis-credentials

  # Prometheus Metrics 설정
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      interval: 30s
      scrapeTimeout: 10s

#########################################################################
# Database 설정 (PostgreSQL 15.15-alpine)
#########################################################################
database:
  enabled: true
  replicaCount: 1

  image:
    repository: postgres
    tag: "15.15-alpine3.22"
    pullPolicy: IfNotPresent

  imagePullSecrets: []
  nameOverride: ""
  fullnameOverride: ""

  podAnnotations: {}
  podLabels:
    app: "ojeomneo-database"

  podSecurityContext:
    fsGroup: 999

  securityContext:
    runAsUser: 999
    runAsGroup: 999

  postgresql:
    database: ojeomneo
    existingSecret: ojeomneo-db-credentials
    secretKeys:
      username: POSTGRES_USER
      password: POSTGRES_PASSWORD

  service:
    type: ClusterIP
    port: 5432

  persistence:
    enabled: true
    accessModes:
      - ReadWriteOnce
    size: 10Gi
    storageClass: ""

  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  livenessProbe:
    exec:
      command:
        - /bin/sh
        - -c
        - exec pg_isready -U $POSTGRES_USER -d $POSTGRES_DB -h 127.0.0.1 -p 5432
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 6

  readinessProbe:
    exec:
      command:
        - /bin/sh
        - -c
        - exec pg_isready -U $POSTGRES_USER -d $POSTGRES_DB -h 127.0.0.1 -p 5432
    initialDelaySeconds: 5
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 6

  nodeSelector: {}
  tolerations: []
  affinity: {}

#########################################################################
# Admin 설정 (Django Admin)
#########################################################################
admin:
  enabled: true
  replicaCount: 1
  revisionHistoryLimit: 1

  image:
    repository: ggorockee/ojeomneo-admin
    pullPolicy: IfNotPresent
    tag: "20251204-89c781b"

  imagePullSecrets: []
  nameOverride: ""
  fullnameOverride: ""

  serviceAccount:
    create: true
    automount: true
    annotations: {}
    name: ""

  podAnnotations: {}
  podLabels:
    app: "ojeomneo-admin"

  podSecurityContext: {}
  securityContext: {}

  service:
    type: ClusterIP
    port: 8000
    portName: "gunicorn"

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi

  # Health check probes - Django Admin
  # /ojeomneo/v1/healthcheck/live/  - K8s startup/liveness probe (항상 200)
  # /ojeomneo/v1/healthcheck/ready/ - K8s readiness probe (DB 체크)
  livenessProbe:
    httpGet:
      path: /ojeomneo/v1/healthcheck/live/
      port: gunicorn
      scheme: HTTP
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  readinessProbe:
    httpGet:
      path: /ojeomneo/v1/healthcheck/ready/
      port: gunicorn
      scheme: HTTP
    initialDelaySeconds: 5
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  startupProbe:
    httpGet:
      path: /ojeomneo/v1/healthcheck/live/
      port: gunicorn
      scheme: HTTP
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 10
    failureThreshold: 18

  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 3
    targetCPUUtilizationPercentage: 80

  volumes: []
  volumeMounts: []
  nodeSelector: {}
  tolerations: []
  affinity: {}

  configMap:
    enabled: true
    name: ""
    data:
      DJANGO_DEBUG: "False"
      # Redis 연결 설정
      REDIS_HOST: "ojeomneo-redis-master"
      REDIS_PORT: "6379"
      # Server API URL (이미지 업로드용) - K8s 내부 서비스 호출
      SERVER_API_URL: "http://ojeomneo-server:3000/ojeomneo/v1"

  secret:
    enabled: true
    names:
      - ojeomneo-admin-credentials
      - ojeomneo-db-credentials
      - ojeomneo-redis-credentials

#########################################################################
# Redis 설정 (Bitnami Redis)
#########################################################################
redis:
  enabled: true

  # 아키텍처: replication (HA) - Master 1 + Replica 1
  architecture: replication

  # 이미지 설정 (Bitnami 2025.08 이후 latest 태그만 지원)
  image:
    registry: docker.io
    repository: bitnami/redis
    tag: latest

  # 인증 설정
  auth:
    enabled: true
    existingSecret: "ojeomneo-redis-credentials"
    existingSecretPasswordKey: "redis-password"

  # 공통 Redis 설정
  commonConfiguration: |-
    maxmemory 200mb
    maxmemory-policy allkeys-lru

  # Master 설정
  master:
    count: 1
    persistence:
      enabled: true
      size: 1Gi
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 250m
        memory: 256Mi

  # Replica 설정
  replica:
    replicaCount: 1
    persistence:
      enabled: true
      size: 1Gi
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 250m
        memory: 256Mi

  # Metrics (Prometheus)
  metrics:
    enabled: true
    image:
      registry: docker.io
      repository: bitnami/redis-exporter
      tag: latest
    serviceMonitor:
      enabled: true
      namespace: ""
      interval: 30s
    resources:
      requests:
        cpu: 10m
        memory: 32Mi
      limits:
        cpu: 50m
        memory: 64Mi
