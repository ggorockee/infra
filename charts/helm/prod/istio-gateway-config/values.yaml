# Istio Gateway and VirtualService Configuration

# Gateway Configuration
gateway:
  enabled: true
  name: main-gateway
  namespace: istio-system

  selector:
    istio: ingressgateway

  # HTTP to HTTPS redirect
  http:
    enabled: true
    port: 80
    httpsRedirect: true

  # HTTPS TLS configurations
  https:
    enabled: true
    port: 443

    # TLS configurations per domain
    tls:
      - name: ggorockee-com
        hosts:
          - "*.ggorockee.com"
          - "ggorockee.com"
        credentialName: ggorockee-com-wildcard-tls

      - name: ggorockee-org
        hosts:
          - "*.ggorockee.org"
          - "ggorockee.org"
        credentialName: ggorockee-org-wildcard-tls

      - name: woohalabs-com
        hosts:
          - "*.woohalabs.com"
          - "woohalabs.com"
        credentialName: woohalabs-com-wildcard-tls

      - name: review-maps-com
        hosts:
          - "*.review-maps.com"
          - "review-maps.com"
        credentialName: review-maps-com-wildcard-tls

# Security Configuration (비용 최소화: Istio Local Rate Limiting 사용)
security:
  # Rate Limiting 설정 (Cloud Armor 대신 Istio EnvoyFilter 사용, 비용 $0)
  rateLimit:
    enabled: false  # Temporarily disabled due to configuration issues
    name: istio-ratelimit

    # Global Rate Limiting (전체 트래픽)
    global:
      maxTokens: 100          # 최대 토큰 수
      tokensPerFill: 100      # 채울 토큰 수
      fillInterval: "60s"     # 채우기 간격 (분당 100 요청)

    # Login Path Rate Limiting (브루트 포스 방지)
    loginPath:
      enabled: true
      maxTokens: 10           # 최대 토큰 수
      tokensPerFill: 10       # 채울 토큰 수
      fillInterval: "60s"     # 채우기 간격 (분당 10 요청)
      paths:
        - "/api/auth/login"
        - "/api/v1/auth/login"
        - "/auth/login"
        - "/login"

    # Admin Path Rate Limiting (관리자 경로 보호)
    adminPath:
      enabled: true
      maxTokens: 30           # 최대 토큰 수
      tokensPerFill: 30       # 채울 토큰 수
      fillInterval: "60s"     # 채우기 간격 (분당 30 요청)

    # ArgoCD Dex OAuth Callback Rate Limiting (OAuth 공격 방지)
    dexCallback:
      enabled: true
      maxTokens: 20           # 최대 토큰 수
      tokensPerFill: 20       # 채울 토큰 수
      fillInterval: "60s"     # 채우기 간격 (분당 20 요청)
      paths:
        - "/api/dex/callback"
        - "/auth/callback"

  # Authorization Policy 설정 (추가 보안)
  authorization:
    enabled: true
    name: istio-authz
    action: ALLOW

    # 허용된 HTTP 메서드
    allowedMethods:
      - GET
      - POST
      - PUT
      - DELETE
      - PATCH
      - OPTIONS
      - HEAD

    # 차단할 경로
    denyPaths: []
      # - "/.env"
      # - "/.git"
      # - "/admin/debug"

    # IP Whitelist (관리자 경로)
    ipWhitelist:
      enabled: false  # 필요 시 활성화
      adminPaths:
        - "/admin/*"
        - "/api/admin/*"
      allowedIPs:
        # - "YOUR_OFFICE_IP/32"
        # - "YOUR_VPN_IP/32"

    # User-Agent Blacklist (악성 봇 차단)
    userAgentBlacklist:
      enabled: true
      patterns:
        - "*sqlmap*"
        - "*nikto*"
        - "*masscan*"
        - "*nmap*"
        - "*ZmEu*"
        - "*bot*scanner*"

    # Country-based Blocking (국가 기반 차단)
    countryBlocking:
      enabled: false  # 필요 시 활성화
      blockedCountries: []
        # - "CN"  # China
        # - "RU"  # Russia
        # - "KP"  # North Korea

# VirtualService configurations
# Each VirtualService is deployed to its respective namespace
virtualServices:
  # ArgoCD
  - name: argocd-vs
    namespace: argocd
    enabled: true
    hosts:
      - "argocd.ggorockee.com"
    http:
      - route:
          - destination:
              host: argocd-server
              port: 80

  # Ojeomneo Admin
  - name: ojeomneo-admin-vs
    namespace: ojeomneo
    enabled: true
    hosts:
      - "admin.woohalabs.com"
    http:
      - match:
          - uri:
              prefix: "/ojeomneo"
        route:
          - destination:
              host: ojeomneo-admin
              port: 8000

  # Ojeomneo API
  - name: ojeomneo-api-vs
    namespace: ojeomneo
    enabled: true
    hosts:
      - "api.woohalabs.com"
    http:
      - match:
          - uri:
              prefix: "/ojeomneo"
        route:
          - destination:
              host: ojeomneo-server
              port: 3000

  # ReviewMaps Admin (Django Admin)
  - name: reviewmaps-admin-vs
    namespace: reviewmaps
    enabled: true
    hosts:
      - "admin.review-maps.com"
    http:
      - route:
          - destination:
              host: reviewmaps-admin
              port: 8000

  # ReviewMaps Server (Go Fiber API)
  - name: reviewmaps-server-vs
    namespace: reviewmaps
    enabled: true
    hosts:
      - "api.review-maps.com"
    http:
      - route:
          - destination:
              host: reviewmaps-server
              port: 3000

  # Ojeomneo Web (Next.js)
  - name: ojeomneo-web-vs
    namespace: ojeomneo
    enabled: true
    hosts:
      - "woohalabs.com"
    http:
      - match:
          - uri:
              prefix: "/ojeomneo"
        route:
          - destination:
              host: ojeomneo-web
              port: 3000

  # ReviewMaps Main (전체 도메인)
  - name: reviewmaps-main-vs
    namespace: reviewmaps
    enabled: true
    hosts:
      - "review-maps.com"
    http:
      - route:
          - destination:
              host: reviewmaps-server
              port: 3000
