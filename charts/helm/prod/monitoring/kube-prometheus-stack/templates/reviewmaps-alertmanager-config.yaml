# ReviewMaps AlertManager SMTP Configuration
# SMTP ì„¤ì •ì€ reviewmaps ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ reviewmaps-api-credentials ì‹œí¬ë¦¿ì„ ì°¸ì¡°í•©ë‹ˆë‹¤.
# ì‹œí¬ë¦¿ ê°’ì€ Gitì— í¬í•¨ë˜ì§€ ì•Šìœ¼ë©°, Kubernetes Secretìœ¼ë¡œë§Œ ê´€ë¦¬ë©ë‹ˆë‹¤.
#
# âš ï¸ ì¤‘ìš”: AlertManagerëŠ” authSecretì—ì„œ 'username'ê³¼ 'password' í‚¤ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
# reviewmaps-api-credentials ì‹œí¬ë¦¿ì˜ í‚¤ ì´ë¦„ì´ EMAIL_HOST_USER, EMAIL_HOST_PASSWORDì´ë¯€ë¡œ
# monitoring ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ë³„ë„ ì‹œí¬ë¦¿ì„ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤:
#
# kubectl create secret generic alertmanager-smtp-credentials \
#   --from-literal=username=$(kubectl get secret -n reviewmaps reviewmaps-api-credentials -o jsonpath='{.data.EMAIL_HOST_USER}' | base64 -d) \
#   --from-literal=password=$(kubectl get secret -n reviewmaps reviewmaps-api-credentials -o jsonpath='{.data.EMAIL_HOST_PASSWORD}' | base64 -d) \
#   -n monitoring
#
# ê·¸ í›„ ì•„ë˜ authSecretì˜ nameì„ 'alertmanager-smtp-credentials'ë¡œ ë³€ê²½í•˜ì„¸ìš”.

apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: reviewmaps-smtp-config
  namespace: monitoring
  labels:
    app: reviewmaps
spec:
  route:
    receiver: 'reviewmaps-email'
    groupBy: ['alertname', 'severity']
    groupWait: 30s
    groupInterval: 5m
    repeatInterval: 12h
    routes:
      # Critical ì•ŒëŒì€ ì¦‰ì‹œ ë°œì†¡
      - receiver: 'reviewmaps-email-critical'
        matchers:
          - severity = critical
        groupWait: 10s
        repeatInterval: 1h
      # Warning ì•ŒëŒì€ ê·¸ë£¹í™”í•˜ì—¬ ë°œì†¡
      - receiver: 'reviewmaps-email-warning'
        matchers:
          - severity = warning
        groupWait: 5m
        repeatInterval: 6h
      # Info ì•ŒëŒì€ í•˜ë£¨ì— í•œ ë²ˆ
      - receiver: 'reviewmaps-email-info'
        matchers:
          - severity = info
        groupWait: 1h
        repeatInterval: 24h

  receivers:
    # Critical ì•ŒëŒ ìˆ˜ì‹ ì
    - name: 'reviewmaps-email-critical'
      emailConfigs:
        - to: '{{`{{ .CommonLabels.service }}`}} ì•ŒëŒ <noreply@reviewmaps.com>'
          from: 'ReviewMaps AlertManager <noreply@reviewmaps.com>'
          smarthost: 'smtp.gmail.com:587'
          authSecret:
            name: reviewmaps-api-credentials
            namespace: reviewmaps
          requireTLS: true
          # Note: AlertManagerëŠ” authSecretì—ì„œ usernameê³¼ passwordë¥¼ ì°¾ìŠµë‹ˆë‹¤.
          # reviewmaps-api-credentials ì‹œí¬ë¦¿ì˜ EMAIL_HOST_USERì™€ EMAIL_HOST_PASSWORDë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
          # ì‹œí¬ë¦¿ í‚¤ ì´ë¦„ì´ ë‹¤ë¥´ë©´ monitoring ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ë³„ë„ ì‹œí¬ë¦¿ ìƒì„± í•„ìš”
          headers:
            Subject: '[CRITICAL] ReviewMaps {{`{{ .GroupLabels.alertname }}`}}'
          html: |
            <h2>ğŸš¨ Critical Alert: {{`{{ .GroupLabels.alertname }}`}}</h2>
            <p><strong>Severity:</strong> {{`{{ .GroupLabels.severity }}`}}</p>
            <p><strong>Service:</strong> {{`{{ .GroupLabels.service }}`}}</p>
            <p><strong>Summary:</strong> {{`{{ .CommonAnnotations.summary }}`}}</p>
            <p><strong>Description:</strong> {{`{{ .CommonAnnotations.description }}`}}</p>
            <hr>
            <h3>Alerts:</h3>
            {{`{{ range .Alerts }}`}}
            <div style="border: 2px solid red; padding: 10px; margin: 10px 0;">
              <p><strong>Alert:</strong> {{`{{ .Labels.alertname }}`}}</p>
              <p><strong>Status:</strong> {{`{{ .Status }}`}}</p>
              <p><strong>Starts At:</strong> {{`{{ .StartsAt }}`}}</p>
              {{`{{ if .Annotations.summary }}`}}<p><strong>Summary:</strong> {{`{{ .Annotations.summary }}`}}</p>{{`{{ end }}`}}
              {{`{{ if .Annotations.description }}`}}<p><strong>Description:</strong> {{`{{ .Annotations.description }}`}}</p>{{`{{ end }}`}}
            </div>
            {{`{{ end }}`}}

    # Warning ì•ŒëŒ ìˆ˜ì‹ ì
    - name: 'reviewmaps-email-warning'
      emailConfigs:
        - to: '{{`{{ .CommonLabels.service }}`}} ì•ŒëŒ <noreply@reviewmaps.com>'
          from: 'ReviewMaps AlertManager <noreply@reviewmaps.com>'
          smarthost: 'smtp.gmail.com:587'
          authSecret:
            name: reviewmaps-api-credentials
            namespace: reviewmaps
          requireTLS: true
          # Note: AlertManagerëŠ” authSecretì—ì„œ usernameê³¼ passwordë¥¼ ì°¾ìŠµë‹ˆë‹¤.
          # reviewmaps-api-credentials ì‹œí¬ë¦¿ì˜ EMAIL_HOST_USERì™€ EMAIL_HOST_PASSWORDë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
          # ì‹œí¬ë¦¿ í‚¤ ì´ë¦„ì´ ë‹¤ë¥´ë©´ monitoring ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ë³„ë„ ì‹œí¬ë¦¿ ìƒì„± í•„ìš”
          headers:
            Subject: '[WARNING] ReviewMaps {{`{{ .GroupLabels.alertname }}`}}'
          html: |
            <h2>âš ï¸ Warning Alert: {{`{{ .GroupLabels.alertname }}`}}</h2>
            <p><strong>Severity:</strong> {{`{{ .GroupLabels.severity }}`}}</p>
            <p><strong>Service:</strong> {{`{{ .GroupLabels.service }}`}}</p>
            <p><strong>Summary:</strong> {{`{{ .CommonAnnotations.summary }}`}}</p>
            <hr>
            <h3>Alerts:</h3>
            {{`{{ range .Alerts }}`}}
            <div style="border: 1px solid orange; padding: 10px; margin: 10px 0;">
              <p><strong>Alert:</strong> {{`{{ .Labels.alertname }}`}}</p>
              <p><strong>Status:</strong> {{`{{ .Status }}`}}</p>
              <p><strong>Starts At:</strong> {{`{{ .StartsAt }}`}}</p>
            </div>
            {{`{{ end }}`}}

    # Info ì•ŒëŒ ìˆ˜ì‹ ì
    - name: 'reviewmaps-email-info'
      emailConfigs:
        - to: '{{`{{ .CommonLabels.service }}`}} ì•ŒëŒ <noreply@reviewmaps.com>'
          from: 'ReviewMaps AlertManager <noreply@reviewmaps.com>'
          smarthost: 'smtp.gmail.com:587'
          authSecret:
            name: reviewmaps-api-credentials
            namespace: reviewmaps
          requireTLS: true
          # Note: AlertManagerëŠ” authSecretì—ì„œ usernameê³¼ passwordë¥¼ ì°¾ìŠµë‹ˆë‹¤.
          # reviewmaps-api-credentials ì‹œí¬ë¦¿ì˜ EMAIL_HOST_USERì™€ EMAIL_HOST_PASSWORDë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
          # ì‹œí¬ë¦¿ í‚¤ ì´ë¦„ì´ ë‹¤ë¥´ë©´ monitoring ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ë³„ë„ ì‹œí¬ë¦¿ ìƒì„± í•„ìš”
          headers:
            Subject: '[INFO] ReviewMaps {{`{{ .GroupLabels.alertname }}`}}'
          html: |
            <h2>â„¹ï¸ Info Alert: {{`{{ .GroupLabels.alertname }}`}}</h2>
            <p><strong>Service:</strong> {{`{{ .GroupLabels.service }}`}}</p>
            <p><strong>Summary:</strong> {{`{{ .CommonAnnotations.summary }}`}}</p>

    # ê¸°ë³¸ ìˆ˜ì‹ ì (fallback)
    - name: 'reviewmaps-email'
      emailConfigs:
        - to: 'ReviewMaps ì•ŒëŒ <noreply@reviewmaps.com>'
          from: 'ReviewMaps AlertManager <noreply@reviewmaps.com>'
          smarthost: 'smtp.gmail.com:587'
          authSecret:
            name: reviewmaps-api-credentials
            namespace: reviewmaps
          requireTLS: true
          # Note: AlertManagerëŠ” authSecretì—ì„œ usernameê³¼ passwordë¥¼ ì°¾ìŠµë‹ˆë‹¤.
          # reviewmaps-api-credentials ì‹œí¬ë¦¿ì˜ EMAIL_HOST_USERì™€ EMAIL_HOST_PASSWORDë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
          # ì‹œí¬ë¦¿ í‚¤ ì´ë¦„ì´ ë‹¤ë¥´ë©´ monitoring ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ë³„ë„ ì‹œí¬ë¦¿ ìƒì„± í•„ìš”
          headers:
            Subject: 'ReviewMaps Alert: {{`{{ .GroupLabels.alertname }}`}}'

