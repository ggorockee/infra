# ReviewMaps AlertManager SMTP Configuration
#
# âš ï¸ ì‚¬ì „ ì¤€ë¹„: monitoring ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— SMTP ì¸ì¦ ì‹œí¬ë¦¿ ìƒì„± í•„ìš”
# AlertmanagerConfigëŠ” ê°™ì€ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ ì‹œí¬ë¦¿ë§Œ ì°¸ì¡°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
#
# kubectl create secret generic alertmanager-smtp-credentials -n monitoring \
#   --from-literal=username=<SMTP_USERNAME> \
#   --from-literal=password=<SMTP_PASSWORD>

apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: reviewmaps-smtp-config
  namespace: monitoring
  labels:
    app: reviewmaps
spec:
  route:
    receiver: 'reviewmaps-email'
    groupBy: ['alertname', 'severity']
    groupWait: 30s
    groupInterval: 5m
    repeatInterval: 12h
    routes:
      # Critical ì•ŒëŒì€ ì¦‰ì‹œ ë°œì†¡
      - receiver: 'reviewmaps-email-critical'
        matchers:
          - severity = critical
        groupWait: 10s
        repeatInterval: 1h
      # Warning ì•ŒëŒì€ ê·¸ë£¹í™”í•˜ì—¬ ë°œì†¡
      - receiver: 'reviewmaps-email-warning'
        matchers:
          - severity = warning
        groupWait: 5m
        repeatInterval: 6h
      # Info ì•ŒëŒì€ í•˜ë£¨ì— í•œ ë²ˆ
      - receiver: 'reviewmaps-email-info'
        matchers:
          - severity = info
        groupWait: 1h
        repeatInterval: 24h

  receivers:
    # Critical ì•ŒëŒ ìˆ˜ì‹ ì
    # Note: authSecretì€ ê°™ì€ ë„¤ì„ìŠ¤í˜ì´ìŠ¤(monitoring)ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
    # kubectl create secret generic alertmanager-smtp-credentials -n monitoring \
    #   --from-literal=username=<SMTP_USER> --from-literal=password=<SMTP_PASSWORD>
    - name: 'reviewmaps-email-critical'
      emailConfigs:
        - to: 'reviewmaps-alerts@reviewmaps.com'
          from: 'ReviewMaps AlertManager <noreply@reviewmaps.com>'
          smarthost: 'smtp.gmail.com:587'
          authUsername:
            name: alertmanager-smtp-credentials
            key: username
          authPassword:
            name: alertmanager-smtp-credentials
            key: password
          requireTLS: true
          headers:
            - key: Subject
              value: '[CRITICAL] ReviewMaps {{`{{ .GroupLabels.alertname }}`}}'
          html: |
            <h2>ğŸš¨ Critical Alert: {{`{{ .GroupLabels.alertname }}`}}</h2>
            <p><strong>Severity:</strong> {{`{{ .GroupLabels.severity }}`}}</p>
            <p><strong>Service:</strong> {{`{{ .GroupLabels.service }}`}}</p>
            <p><strong>Summary:</strong> {{`{{ .CommonAnnotations.summary }}`}}</p>
            <p><strong>Description:</strong> {{`{{ .CommonAnnotations.description }}`}}</p>
            <hr>
            <h3>Alerts:</h3>
            {{`{{ range .Alerts }}`}}
            <div style="border: 2px solid red; padding: 10px; margin: 10px 0;">
              <p><strong>Alert:</strong> {{`{{ .Labels.alertname }}`}}</p>
              <p><strong>Status:</strong> {{`{{ .Status }}`}}</p>
              <p><strong>Starts At:</strong> {{`{{ .StartsAt }}`}}</p>
              {{`{{ if .Annotations.summary }}`}}<p><strong>Summary:</strong> {{`{{ .Annotations.summary }}`}}</p>{{`{{ end }}`}}
              {{`{{ if .Annotations.description }}`}}<p><strong>Description:</strong> {{`{{ .Annotations.description }}`}}</p>{{`{{ end }}`}}
            </div>
            {{`{{ end }}`}}

    # Warning ì•ŒëŒ ìˆ˜ì‹ ì
    - name: 'reviewmaps-email-warning'
      emailConfigs:
        - to: 'reviewmaps-alerts@reviewmaps.com'
          from: 'ReviewMaps AlertManager <noreply@reviewmaps.com>'
          smarthost: 'smtp.gmail.com:587'
          authUsername:
            name: alertmanager-smtp-credentials
            key: username
          authPassword:
            name: alertmanager-smtp-credentials
            key: password
          requireTLS: true
          headers:
            - key: Subject
              value: '[WARNING] ReviewMaps {{`{{ .GroupLabels.alertname }}`}}'
          html: |
            <h2>âš ï¸ Warning Alert: {{`{{ .GroupLabels.alertname }}`}}</h2>
            <p><strong>Severity:</strong> {{`{{ .GroupLabels.severity }}`}}</p>
            <p><strong>Service:</strong> {{`{{ .GroupLabels.service }}`}}</p>
            <p><strong>Summary:</strong> {{`{{ .CommonAnnotations.summary }}`}}</p>
            <hr>
            <h3>Alerts:</h3>
            {{`{{ range .Alerts }}`}}
            <div style="border: 1px solid orange; padding: 10px; margin: 10px 0;">
              <p><strong>Alert:</strong> {{`{{ .Labels.alertname }}`}}</p>
              <p><strong>Status:</strong> {{`{{ .Status }}`}}</p>
              <p><strong>Starts At:</strong> {{`{{ .StartsAt }}`}}</p>
            </div>
            {{`{{ end }}`}}

    # Info ì•ŒëŒ ìˆ˜ì‹ ì
    - name: 'reviewmaps-email-info'
      emailConfigs:
        - to: 'reviewmaps-alerts@reviewmaps.com'
          from: 'ReviewMaps AlertManager <noreply@reviewmaps.com>'
          smarthost: 'smtp.gmail.com:587'
          authUsername:
            name: alertmanager-smtp-credentials
            key: username
          authPassword:
            name: alertmanager-smtp-credentials
            key: password
          requireTLS: true
          headers:
            - key: Subject
              value: '[INFO] ReviewMaps {{`{{ .GroupLabels.alertname }}`}}'
          html: |
            <h2>â„¹ï¸ Info Alert: {{`{{ .GroupLabels.alertname }}`}}</h2>
            <p><strong>Service:</strong> {{`{{ .GroupLabels.service }}`}}</p>
            <p><strong>Summary:</strong> {{`{{ .CommonAnnotations.summary }}`}}</p>

    # ê¸°ë³¸ ìˆ˜ì‹ ì (fallback)
    - name: 'reviewmaps-email'
      emailConfigs:
        - to: 'reviewmaps-alerts@reviewmaps.com'
          from: 'ReviewMaps AlertManager <noreply@reviewmaps.com>'
          smarthost: 'smtp.gmail.com:587'
          authUsername:
            name: alertmanager-smtp-credentials
            key: username
          authPassword:
            name: alertmanager-smtp-credentials
            key: password
          requireTLS: true
          headers:
            - key: Subject
              value: 'ReviewMaps Alert: {{`{{ .GroupLabels.alertname }}`}}'

