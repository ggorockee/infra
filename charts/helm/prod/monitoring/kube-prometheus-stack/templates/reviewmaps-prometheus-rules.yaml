# ReviewMaps Prometheus Alert Rules

apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: reviewmaps-alerts
  namespace: monitoring
  labels:
    release: kube-prometheus-stack
    app: kube-prometheus-stack
spec:
  groups:
    - name: reviewmaps.critical
      interval: 30s
      rules:
        - alert: ReviewMapsServiceDown
          expr: reviewmaps_service_up{service="django"} == 0
          for: 5m
          labels:
            severity: critical
            service: reviewmaps
          annotations:
            summary: "ReviewMaps Django 서비스 다운"
            description: "ReviewMaps Django 서비스가 5분 이상 다운 상태입니다. 즉시 확인이 필요합니다."

        - alert: ReviewMapsHighErrorRate
          expr: |
            (sum(rate(django_http_responses_total_by_status_total{app="reviewmaps-server", status=~"5.."}[5m]))
            / sum(rate(django_http_responses_total_by_status_total{app="reviewmaps-server"}[5m]))) > 0.05
          for: 5m
          labels:
            severity: critical
            service: reviewmaps
          annotations:
            summary: "ReviewMaps 높은 에러율 (5XX > 5%)"
            description: "ReviewMaps에서 5XX 에러율이 5% 이상입니다. 현재 에러율: {{`{{ $value | humanizePercentage }}`}}"

        - alert: ReviewMapsDBConnectionError
          expr: increase(django_db_new_connection_errors_total{app="reviewmaps-server"}[5m]) > 10
          for: 1m
          labels:
            severity: critical
            service: reviewmaps
          annotations:
            summary: "ReviewMaps DB 연결 에러 다발"
            description: "5분 동안 10회 이상의 DB 연결 에러가 발생했습니다."

    - name: reviewmaps.warning
      interval: 1m
      rules:
        - alert: ReviewMapsSlowResponse
          expr: |
            histogram_quantile(0.95, 
              sum(rate(django_http_requests_latency_seconds_by_view_method_bucket{app="reviewmaps-server"}[10m])) by (le)
            ) > 1
          for: 10m
          labels:
            severity: warning
            service: reviewmaps
          annotations:
            summary: "ReviewMaps 응답 속도 저하 (P95 > 1초)"
            description: "ReviewMaps의 P95 응답 시간이 1초를 초과했습니다. 현재: {{`{{ $value }}`}}초"

        - alert: ReviewMapsHighMemoryUsage
          expr: |
            (process_resident_memory_bytes{namespace="reviewmaps", pod=~"reviewmaps-server.*"} 
            / 1024 / 1024 / 1024) > 0.8
          for: 10m
          labels:
            severity: warning
            service: reviewmaps
          annotations:
            summary: "ReviewMaps 메모리 사용률 높음 (> 800MB)"
            description: "ReviewMaps 서버 메모리 사용량이 높습니다. 현재: {{`{{ $value | humanize }}`}}GB"

        - alert: ReviewMapsExceptionSpike
          expr: increase(reviewmaps_exceptions_total[5m]) > 50
          for: 5m
          labels:
            severity: warning
            service: reviewmaps
          annotations:
            summary: "ReviewMaps 예외 발생 급증"
            description: "5분 동안 50회 이상의 예외가 발생했습니다. 타입: {{`{{ $labels.exception_type }}`}}"

        - alert: ReviewMapsNaverAPIRateLimit
          expr: increase(reviewmaps_naver_api_rate_limit_hits[5m]) > 0
          for: 1m
          labels:
            severity: warning
            service: reviewmaps
          annotations:
            summary: "Naver API Rate Limit 도달"
            description: "Naver API Rate Limit에 도달했습니다. API 호출을 조절해야 합니다."

    - name: reviewmaps.info
      interval: 5m
      rules:
        - alert: ReviewMapsLowCacheHitRate
          expr: |
            (sum(django_cache_get_hits_total{app="reviewmaps-server"}) by (backend) 
            / sum(django_cache_get_total{app="reviewmaps-server"}) by (backend)) < 0.5
          for: 15m
          labels:
            severity: info
            service: reviewmaps
          annotations:
            summary: "ReviewMaps 캐시 히트율 낮음 (< 50%)"
            description: "캐시 효율이 낮습니다. 캐시 전략 검토가 필요합니다. 현재: {{`{{ $value | humanizePercentage }}`}}"

