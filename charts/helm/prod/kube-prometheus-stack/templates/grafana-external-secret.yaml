{{- if .Values.externalSecret.enabled }}
---
# ExternalSecret for Grafana OAuth credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ .Values.externalSecret.name }}
  namespace: {{ .Values.externalSecret.namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
    # ArgoCD가 status 필드 변경을 무시하도록 설정
    # External Secrets Operator가 주기적으로 status를 업데이트하므로
    # 이 필드들의 변경은 실제 drift가 아님
    argocd.argoproj.io/compare-options: IgnoreExtraneous
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/component: oauth
    managed-by: argocd
spec:
  # 동기화 주기
  refreshInterval: {{ .Values.externalSecret.refreshInterval }}

  # GCP Secret Manager를 SecretStore로 사용
  secretStoreRef:
    name: {{ .Values.externalSecret.clusterSecretStoreName }}
    kind: ClusterSecretStore

  # 생성될 Kubernetes Secret 설정
  target:
    name: {{ .Values.externalSecret.name }}
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        # Google OAuth Client ID
        client_id: "{{ `{{` }} .clientId {{ `}}` }}"
        # Google OAuth Client Secret
        client_secret: "{{ `{{` }} .clientSecret {{ `}}` }}"

  # GCP Secret Manager에서 가져올 데이터
  data:
    - secretKey: clientId
      remoteRef:
        key: {{ .Values.externalSecret.gcpSecretName }}
        property: {{ .Values.externalSecret.properties.clientId }}

    - secretKey: clientSecret
      remoteRef:
        key: {{ .Values.externalSecret.gcpSecretName }}
        property: {{ .Values.externalSecret.properties.clientSecret }}
{{- end }}
