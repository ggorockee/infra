# Kube-Prometheus-Stack Custom Values Override
# 1ì¸ ê°œë°œììš© ëª¨ë‹ˆí„°ë§ ìŠ¤íƒ ì„¤ì •

# External Secret ì„¤ì •
externalSecret:
  enabled: true
  name: "grafana-oauth-secret"
  namespace: "monitoring"
  refreshInterval: "5m"
  clusterSecretStoreName: "gcpsm-secret-store"
  gcpSecretName: "prod-argocd-dex-credentials"
  # GCP Secret Managerì—ì„œ ê°€ì ¸ì˜¬ ì†ì„±ë“¤
  properties:
    clientId: "google.clientId"
    clientSecret: "google.clientSecret"

# ClusterSecretStore ì„¤ì •
# NOTE: ClusterSecretStoreëŠ” Terraformì—ì„œ ê´€ë¦¬ë©ë‹ˆë‹¤ (gcp/terraform/modules/external-secrets/cluster-secret-store.tf)
# Helm ì°¨íŠ¸ì—ì„œëŠ” ìƒì„±í•˜ì§€ ì•Šê³ , ê¸°ì¡´ ClusterSecretStoreë¥¼ ì°¸ì¡°ë§Œ í•©ë‹ˆë‹¤.
clusterSecretStore:
  enabled: false  # Terraformì—ì„œ ê´€ë¦¬í•˜ë¯€ë¡œ ë¹„í™œì„±í™”
  name: "gcpsm-secret-store"
  gcpProjectID: "infra-480802"
  clusterLocation: "asia-northeast3-a"
  clusterName: "woohalabs-prod-gke"
  serviceAccount:
    name: "external-secrets"
    namespace: "external-secrets-system"
    gcpServiceAccount: "external-secrets-prod@infra-480802.iam.gserviceaccount.com"

# Grafana ì„¤ì •
grafana:
  enabled: true

  # Deployment ì „ëµ: Recreate (RWO PVC ì‚¬ìš© ì‹œ í•„ìˆ˜)
  # Rolling UpdateëŠ” ìƒˆ Podë¥¼ ë¨¼ì € ì‹œì‘í•˜ë ¤ í•˜ì§€ë§Œ, RWO PVCëŠ” ë™ì‹œ ë§ˆìš´íŠ¸ ë¶ˆê°€ëŠ¥
  # RecreateëŠ” ì´ì „ Podë¥¼ ë¨¼ì € ì¢…ë£Œí•˜ê³  ìƒˆ Podë¥¼ ì‹œì‘í•˜ì—¬ PVC ì¶©ëŒ ë°©ì§€
  # Grafana subchartëŠ” 'strategy' í•„ë“œë¥¼ ì‚¬ìš© (deploymentStrategy ì•„ë‹˜)
  strategy:
    type: Recreate

  # Grafana External Secret ì„¤ì • (GCP Secret Manager ì—°ë™)
  externalSecret:
    enabled: true
    name: "grafana-oauth-secret"
    namespace: "monitoring"
    refreshInterval: "60m"
    clusterSecretStoreName: "gcpsm-secret-store"
    gcpSecretName: "prod-monitoring-smtp-credentials"
    # GCP Secret Managerì—ì„œ ê°€ì ¸ì˜¬ ì†ì„±ë“¤ (key: property ë§¤í•‘)
    # ì™¼ìª½: Kubernetes Secret í‚¤ (íŒŒì¼ ì´ë¦„ìœ¼ë¡œ ë§ˆìš´íŠ¸ë¨)
    # ì˜¤ë¥¸ìª½: GCP Secret Manager JSON ì†ì„± ê²½ë¡œ
    properties:
      client_id: "google.clientId"
      client_secret: "google.clientSecret"
      admin_emails: "admin.emails"
      admin_password: "password"
      EMAIL_HOST: "EMAIL_HOST"
      EMAIL_PORT: "EMAIL_PORT"
      EMAIL_USE_TLS: "EMAIL_USE_TLS"
      EMAIL_HOST_USER: "EMAIL_HOST_USER"
      EMAIL_HOST_PASSWORD: "EMAIL_HOST_PASSWORD"
      DEFAULT_FROM_EMAIL: "DEFAULT_FROM_EMAIL"

  # ArgoCD Sync Wave ì„¤ì • (External Secretì´ ë¨¼ì € ìƒì„±ë˜ë„ë¡)
  deploymentAnnotations:
    argocd.argoproj.io/sync-wave: "0"

  # Admin ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ (External Secretìœ¼ë¡œ ê´€ë¦¬ ì˜ˆì •)
  adminPassword: "changeme-will-be-overridden-by-external-secret"

  # Persistence ì„¤ì • (GCP Persistent Disk - ë¹„ìš© ìµœì í™”)
  persistence:
    enabled: true
    type: pvc
    storageClassName: "gcp-standard-rwo-retain"  # GCP Retain ì •ì±…ìœ¼ë¡œ ë°ì´í„° ë³´ì¡´
    accessModes:
      - ReadWriteOnce
    size: 5Gi  # Grafana ë°ì´í„° ì¶•ì†Œ (ëŒ€ì‹œë³´ë“œ/ì„¤ì •ë§Œ ì €ì¥)
    finalizers:
      - kubernetes.io/pvc-protection

  # Grafana Ingress ë¹„í™œì„±í™” (Istio VirtualService ì‚¬ìš©)
  ingress:
    enabled: false

  # Service ì„¤ì • (Istioë¥¼ í†µí•œ ì™¸ë¶€ ë…¸ì¶œ)
  service:
    type: ClusterIP
    port: 80
    targetPort: 3000
    portName: http-web

  # Grafana ë„ë©”ì¸ ì„¤ì •
  grafana.ini:
    server:
      domain: grafana.ggorockee.com
      root_url: "https://grafana.ggorockee.com"
      serve_from_sub_path: false

    # Google OAuth (Dex) ì„¤ì •
    auth.generic_oauth:
      enabled: true
      name: Google
      allow_sign_up: true
      client_id: $__file{/etc/secrets/auth/client_id}
      client_secret: $__file{/etc/secrets/auth/client_secret}
      scopes: openid email profile
      auth_url: https://accounts.google.com/o/oauth2/v2/auth
      token_url: https://oauth2.googleapis.com/token
      api_url: https://openidconnect.googleapis.com/v1/userinfo
      allowed_domains: gmail.com
      allow_assign_grafana_admin: true
      role_attribute_path: "(email == 'woohaen88@gmail.com' || email == 'woohalabs@gmail.com' || email == 'ggorockee@gmail.com') && 'Admin' || 'Viewer'"

    # ìµëª… ì ‘ê·¼ ë¹„í™œì„±í™”
    auth.anonymous:
      enabled: false

    # ê¸°ë³¸ ë¡œê·¸ì¸ ë¹„í™œì„±í™” (OAuthë§Œ ì‚¬ìš©)
    auth.basic:
      enabled: false

  # External Secret ë§ˆìš´íŠ¸
  extraSecretMounts:
    - name: auth-generic-oauth-secret
      secretName: grafana-oauth-secret
      defaultMode: 0440
      mountPath: /etc/secrets/auth
      readOnly: true

  # Sidecar ì„¤ì • (ëŒ€ì‹œë³´ë“œ ìë™ ë¡œë“œ)
  sidecar:
    dashboards:
      enabled: true
      label: grafana_dashboard
      labelValue: "1"
      searchNamespace: ALL
    datasources:
      enabled: true
      defaultDatasourceEnabled: true

# Prometheus ì„¤ì •
prometheus:
  enabled: true

  # Prometheus Ingress ë¹„í™œì„±í™” (Istio VirtualService ì‚¬ìš©)
  ingress:
    enabled: false

  # Service ì„¤ì •
  service:
    type: ClusterIP
    port: 9090
    targetPort: 9090
    portName: http-web

  # Prometheus Spec
  prometheusSpec:
    # Retention ì„¤ì • (1ì¸ ê°œë°œììš© - ë¹„ìš© ìµœì í™”)
    retention: 15d
    retentionSize: "18GB"  # ì‹¤ì œ ë°ì´í„° ì œí•œ (20GB ì¤‘ ì—¬ìœ  ê³µê°„ 2GB)

    # ë¦¬ì†ŒìŠ¤ ì œí•œ (1ì¸ ê°œë°œììš©)
    resources:
      requests:
        cpu: 500m
        memory: 2Gi
      limits:
        cpu: 2000m
        memory: 4Gi

    # Persistence ì„¤ì • (GCP Persistent Disk - ë¹„ìš© ìµœì í™”)
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: gcp-standard-rwo-retain  # GCP Retain ì •ì±…ìœ¼ë¡œ ë°ì´í„° ë³´ì¡´
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 20Gi  # PVC ìµœëŒ€ í¬ê¸° 20GB

    # External URL ì„¤ì •
    externalUrl: "https://prom.ggorockee.com"

    # Pod Monitor/Service Monitor ìë™ ë°œê²¬
    podMonitorSelectorNilUsesHelmValues: false
    serviceMonitorSelectorNilUsesHelmValues: false
    ruleSelectorNilUsesHelmValues: false

    # Scrape ê°„ê²©
    scrapeInterval: 30s
    evaluationInterval: 30s

# Alertmanager ì„¤ì •
alertmanager:
  enabled: true

  # ArgoCD ë¦¬ì†ŒìŠ¤ ì¶”ì  ì œì™¸ (Prometheus Operatorê°€ ìƒì„±í•˜ëŠ” StatefulSet/Pod ë³´í˜¸)
  # ArgoCD ServerSideApplyì™€ Operator ì¶©ëŒ ë°©ì§€
  annotations:
    argocd.argoproj.io/sync-options: "Prune=false"

  # Ingress ë¹„í™œì„±í™”
  ingress:
    enabled: false

  # Alertmanager Spec
  alertmanagerSpec:
    # Persistence ì„¤ì • (ë¹„ìš© ìµœì í™”)
    storage:
      volumeClaimTemplate:
        spec:
          storageClassName: gcp-standard-rwo-retain  # GCP Retain ì •ì±…ìœ¼ë¡œ ë°ì´í„° ë³´ì¡´
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 2Gi  # Alert íˆìŠ¤í† ë¦¬ë§Œ ì €ì¥

    # ë¦¬ì†ŒìŠ¤ ì œí•œ
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 200m
        memory: 256Mi

    # External Secret ë§ˆìš´íŠ¸ (SMTP credentials)
    secrets:
      - grafana-oauth-secret  # SMTP credentialsê°€ í¬í•¨ëœ secret

    # SMTP í™˜ê²½ ë³€ìˆ˜ ì£¼ì… (Secretì—ì„œ ë¡œë“œ)
    containers:
      - name: alertmanager
        env:
          - name: SMTP_HOST
            valueFrom:
              secretKeyRef:
                name: grafana-oauth-secret
                key: EMAIL_HOST
          - name: SMTP_PORT
            valueFrom:
              secretKeyRef:
                name: grafana-oauth-secret
                key: EMAIL_PORT
          - name: SMTP_USER
            valueFrom:
              secretKeyRef:
                name: grafana-oauth-secret
                key: EMAIL_HOST_USER
          - name: SMTP_PASSWORD
            valueFrom:
              secretKeyRef:
                name: grafana-oauth-secret
                key: EMAIL_HOST_PASSWORD
          - name: EMAIL_FROM
            valueFrom:
              secretKeyRef:
                name: grafana-oauth-secret
                key: DEFAULT_FROM_EMAIL
          - name: ADMIN_EMAILS
            valueFrom:
              secretKeyRef:
                name: grafana-oauth-secret
                key: admin_emails

  # Alertmanager Config
  config:
    global:
      resolve_timeout: 5m
      smtp_from: $EMAIL_FROM
      smtp_smarthost: $SMTP_HOST:$SMTP_PORT
      smtp_auth_username: $SMTP_USER
      smtp_auth_password: $SMTP_PASSWORD
      smtp_require_tls: true

    route:
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 12h
      receiver: 'email-notifications'
      routes:
        - match:
            severity: critical
          receiver: 'email-critical'
          repeat_interval: 4h
        - match:
            severity: warning
          receiver: 'email-notifications'
          repeat_interval: 12h

    receivers:
      - name: 'email-notifications'
        email_configs:
          - to: $ADMIN_EMAILS
            headers:
              Subject: '[{{ .Status | toUpper }}] {{ .GroupLabels.alertname }} - {{ .CommonLabels.service }}'
            html: |
              <!DOCTYPE html>
              <html>
              <head><meta charset="UTF-8"></head>
              <body>
              <h2>Alert: {{ .GroupLabels.alertname }}</h2>
              <p><strong>Status:</strong> {{ .Status }}</p>
              <p><strong>Severity:</strong> {{ .CommonLabels.severity }}</p>
              <p><strong>Service:</strong> {{ .CommonLabels.service }}</p>
              <h3>Details:</h3>
              <ul>
              {{ range .Alerts }}
                <li>
                  <strong>{{ .Labels.alertname }}</strong><br/>
                  {{ .Annotations.description }}<br/>
                  <em>Started: {{ .StartsAt }}</em>
                </li>
              {{ end }}
              </ul>
              </body>
              </html>

      - name: 'email-critical'
        email_configs:
          - to: $ADMIN_EMAILS
            headers:
              Subject: 'ğŸš¨ [CRITICAL] {{ .GroupLabels.alertname }} - {{ .CommonLabels.service }}'
            html: |
              <!DOCTYPE html>
              <html>
              <head><meta charset="UTF-8"></head>
              <body style="background-color: #ffebee; padding: 20px;">
              <h2 style="color: #c62828;">ğŸš¨ Critical Alert: {{ .GroupLabels.alertname }}</h2>
              <p><strong>Status:</strong> {{ .Status }}</p>
              <p><strong>Severity:</strong> <span style="color: #c62828;">CRITICAL</span></p>
              <p><strong>Service:</strong> {{ .CommonLabels.service }}</p>
              <h3>Immediate Action Required:</h3>
              <ul>
              {{ range .Alerts }}
                <li style="margin-bottom: 10px;">
                  <strong>{{ .Labels.alertname }}</strong><br/>
                  {{ .Annotations.description }}<br/>
                  <em>Started: {{ .StartsAt }}</em>
                </li>
              {{ end }}
              </ul>
              </body>
              </html>

# Prometheus Operator ì„¤ì •
prometheusOperator:
  enabled: true

  # ë¦¬ì†ŒìŠ¤ ì œí•œ
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi

# Node Exporter ì„¤ì •
prometheus-node-exporter:
  enabled: true

# Kube State Metrics ì„¤ì •
kube-state-metrics:
  enabled: true

# Default Rules í™œì„±í™”
defaultRules:
  create: true
  rules:
    alertmanager: true
    etcd: true
    configReloaders: true
    general: true
    k8s: true
    kubeApiserverAvailability: true
    kubeApiserverBurnrate: true
    kubeApiserverHistogram: true
    kubeApiserverSlos: true
    kubeControllerManager: true
    kubelet: true
    kubeProxy: true
    kubePrometheusGeneral: true
    kubePrometheusNodeRecording: true
    kubernetesApps: true
    kubernetesResources: true
    kubernetesStorage: true
    kubernetesSystem: true
    kubeSchedulerAlerting: true
    kubeSchedulerRecording: true
    kubeStateMetrics: true
    network: true
    node: true
    nodeExporterAlerting: true
    nodeExporterRecording: true
    prometheus: true
    prometheusOperator: true

# CoreDNS ì„¤ì • (GKE í™˜ê²½)
coreDns:
  enabled: true
  service:
    enabled: true
    port: 9153  # ServiceMonitorì—ì„œ ì‚¬ìš©í•  í¬íŠ¸
    targetPort: 10054  # GKE CoreDNS ì‹¤ì œ ë©”íŠ¸ë¦­ í¬íŠ¸ (í‘œì¤€ 9153ì´ ì•„ë‹Œ 10054 ì‚¬ìš©)

# ê³µí†µ ë¼ë²¨
commonLabels:
  managed-by: argocd
  environment: production

# Additional Prometheus Rules (Custom Alert Rules)
additionalPrometheusRulesMap:
  custom-application-alerts:
    groups:
      - name: http-performance-alerts
        interval: 30s
        rules:
          # ReviewMaps HTTP Error Rate
          - alert: ReviewMapsHighErrorRate
            expr: |
              (sum(rate(reviewmaps_http_requests_total{status=~"5.."}[5m])) / sum(rate(reviewmaps_http_requests_total[5m]))) * 100 > 5
            for: 5m
            labels:
              severity: critical
              service: reviewmaps
              category: http
            annotations:
              summary: "ReviewMaps HTTP ì—ëŸ¬ìœ¨ì´ ë†’ìŠµë‹ˆë‹¤"
              description: "ReviewMapsì˜ HTTP 5xx ì—ëŸ¬ìœ¨ì´ {{ $value | humanizePercentage }}ë¡œ 5ë¶„ ì´ìƒ 5%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤."
              runbook_url: "https://docs.ggorockee.com/runbooks/high-error-rate"

          # Ojeomneo HTTP Error Rate
          - alert: OjeomneoPlatformHighErrorRate
            expr: |
              (sum(rate(ojeomneo_http_requests_total{status=~"5.."}[5m])) / sum(rate(ojeomneo_http_requests_total[5m]))) * 100 > 5
            for: 5m
            labels:
              severity: critical
              service: ojeomneo
              category: http
            annotations:
              summary: "Ojeomneo HTTP ì—ëŸ¬ìœ¨ì´ ë†’ìŠµë‹ˆë‹¤"
              description: "Ojeomneoì˜ HTTP 5xx ì—ëŸ¬ìœ¨ì´ {{ $value | humanizePercentage }}ë¡œ 5ë¶„ ì´ìƒ 5%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤."
              runbook_url: "https://docs.ggorockee.com/runbooks/high-error-rate"

          # ReviewMaps High Latency
          - alert: ReviewMapsHighLatency
            expr: |
              histogram_quantile(0.95, sum by (le) (rate(reviewmaps_http_request_duration_seconds_bucket[5m]))) > 1
            for: 5m
            labels:
              severity: warning
              service: reviewmaps
              category: http
            annotations:
              summary: "ReviewMaps HTTP ë ˆì´í„´ì‹œê°€ ë†’ìŠµë‹ˆë‹¤"
              description: "ReviewMapsì˜ P95 ë ˆì´í„´ì‹œê°€ {{ $value | humanizeDuration }}ë¡œ 5ë¶„ ì´ìƒ 1ì´ˆë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤."
              runbook_url: "https://docs.ggorockee.com/runbooks/high-latency"

          # Ojeomneo High Latency
          - alert: OjeomneoPlatformHighLatency
            expr: |
              histogram_quantile(0.95, sum by (le) (rate(ojeomneo_http_request_duration_seconds_bucket[5m]))) > 1
            for: 5m
            labels:
              severity: warning
              service: ojeomneo
              category: http
            annotations:
              summary: "Ojeomneo HTTP ë ˆì´í„´ì‹œê°€ ë†’ìŠµë‹ˆë‹¤"
              description: "Ojeomneoì˜ P95 ë ˆì´í„´ì‹œê°€ {{ $value | humanizeDuration }}ë¡œ 5ë¶„ ì´ìƒ 1ì´ˆë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤."
              runbook_url: "https://docs.ggorockee.com/runbooks/high-latency"

      - name: database-performance-alerts
        interval: 30s
        rules:
          # ReviewMaps Slow Queries
          - alert: ReviewMapsDatabaseSlowQueries
            expr: |
              sum(rate(reviewmaps_db_slow_queries_total[5m])) > 1
            for: 5m
            labels:
              severity: warning
              service: reviewmaps
              category: database
            annotations:
              summary: "ReviewMaps ë°ì´í„°ë² ì´ìŠ¤ ìŠ¬ë¡œìš° ì¿¼ë¦¬ê°€ ë§ìŠµë‹ˆë‹¤"
              description: "ReviewMapsì—ì„œ ì´ˆë‹¹ {{ $value | humanize }}ê°œì˜ ìŠ¬ë¡œìš° ì¿¼ë¦¬(>1ì´ˆ)ê°€ 5ë¶„ ì´ìƒ ë°œìƒí•˜ê³  ìˆìŠµë‹ˆë‹¤."
              runbook_url: "https://docs.ggorockee.com/runbooks/slow-queries"

          # Ojeomneo Slow Queries
          - alert: OjeomneoPlatformDatabaseSlowQueries
            expr: |
              sum(rate(ojeomneo_db_slow_queries_total[5m])) > 1
            for: 5m
            labels:
              severity: warning
              service: ojeomneo
              category: database
            annotations:
              summary: "Ojeomneo ë°ì´í„°ë² ì´ìŠ¤ ìŠ¬ë¡œìš° ì¿¼ë¦¬ê°€ ë§ìŠµë‹ˆë‹¤"
              description: "Ojeomneoì—ì„œ ì´ˆë‹¹ {{ $value | humanize }}ê°œì˜ ìŠ¬ë¡œìš° ì¿¼ë¦¬(>1ì´ˆ)ê°€ 5ë¶„ ì´ìƒ ë°œìƒí•˜ê³  ìˆìŠµë‹ˆë‹¤."
              runbook_url: "https://docs.ggorockee.com/runbooks/slow-queries"

          # ReviewMaps Connection Pool Exhaustion
          - alert: ReviewMapsDatabaseConnectionPoolExhaustion
            expr: |
              reviewmaps_db_connection_pool_in_use > 20
            for: 5m
            labels:
              severity: critical
              service: reviewmaps
              category: database
            annotations:
              summary: "ReviewMaps ë°ì´í„°ë² ì´ìŠ¤ ì»¤ë„¥ì…˜ í’€ì´ ê±°ì˜ ê³ ê°ˆë˜ì—ˆìŠµë‹ˆë‹¤"
              description: "ReviewMapsì˜ ì»¤ë„¥ì…˜ í’€ ì‚¬ìš©ëŸ‰ì´ {{ $value }}ê°œë¡œ ìµœëŒ€ 25ê°œ ì¤‘ 80%ë¥¼ 5ë¶„ ì´ìƒ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤."
              runbook_url: "https://docs.ggorockee.com/runbooks/connection-pool-exhaustion"

          # Ojeomneo Connection Pool Exhaustion
          - alert: OjeomneoPlatformDatabaseConnectionPoolExhaustion
            expr: |
              ojeomneo_db_connection_pool_in_use > 20
            for: 5m
            labels:
              severity: critical
              service: ojeomneo
              category: database
            annotations:
              summary: "Ojeomneo ë°ì´í„°ë² ì´ìŠ¤ ì»¤ë„¥ì…˜ í’€ì´ ê±°ì˜ ê³ ê°ˆë˜ì—ˆìŠµë‹ˆë‹¤"
              description: "Ojeomneoì˜ ì»¤ë„¥ì…˜ í’€ ì‚¬ìš©ëŸ‰ì´ {{ $value }}ê°œë¡œ ìµœëŒ€ 25ê°œ ì¤‘ 80%ë¥¼ 5ë¶„ ì´ìƒ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤."
              runbook_url: "https://docs.ggorockee.com/runbooks/connection-pool-exhaustion"

          # ReviewMaps High DB Error Rate
          - alert: ReviewMapsDatabaseHighErrorRate
            expr: |
              sum(rate(reviewmaps_db_errors_total[5m])) > 5
            for: 5m
            labels:
              severity: critical
              service: reviewmaps
              category: database
            annotations:
              summary: "ReviewMaps ë°ì´í„°ë² ì´ìŠ¤ ì—ëŸ¬ìœ¨ì´ ë†’ìŠµë‹ˆë‹¤"
              description: "ReviewMapsì—ì„œ ì´ˆë‹¹ {{ $value | humanize }}ê°œì˜ ë°ì´í„°ë² ì´ìŠ¤ ì—ëŸ¬ê°€ 5ë¶„ ì´ìƒ ë°œìƒí•˜ê³  ìˆìŠµë‹ˆë‹¤."
              runbook_url: "https://docs.ggorockee.com/runbooks/database-errors"

          # Ojeomneo High DB Error Rate
          - alert: OjeomneoPlatformDatabaseHighErrorRate
            expr: |
              sum(rate(ojeomneo_db_errors_total[5m])) > 5
            for: 5m
            labels:
              severity: critical
              service: ojeomneo
              category: database
            annotations:
              summary: "Ojeomneo ë°ì´í„°ë² ì´ìŠ¤ ì—ëŸ¬ìœ¨ì´ ë†’ìŠµë‹ˆë‹¤"
              description: "Ojeomneoì—ì„œ ì´ˆë‹¹ {{ $value | humanize }}ê°œì˜ ë°ì´í„°ë² ì´ìŠ¤ ì—ëŸ¬ê°€ 5ë¶„ ì´ìƒ ë°œìƒí•˜ê³  ìˆìŠµë‹ˆë‹¤."
              runbook_url: "https://docs.ggorockee.com/runbooks/database-errors"

      - name: service-availability-alerts
        interval: 30s
        rules:
          # ReviewMaps Service Down
          - alert: ReviewMapsServiceDown
            expr: |
              sum(rate(reviewmaps_http_requests_total[2m])) == 0
            for: 2m
            labels:
              severity: critical
              service: reviewmaps
              category: availability
            annotations:
              summary: "ReviewMaps ì„œë¹„ìŠ¤ê°€ ë‹¤ìš´ë˜ì—ˆìŠµë‹ˆë‹¤"
              description: "ReviewMapsì—ì„œ 2ë¶„ê°„ HTTP ìš”ì²­ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì„œë¹„ìŠ¤ê°€ ë‹¤ìš´ëœ ê²ƒìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤."
              runbook_url: "https://docs.ggorockee.com/runbooks/service-down"

          # Ojeomneo Service Down
          - alert: OjeomneoPlatformServiceDown
            expr: |
              sum(rate(ojeomneo_http_requests_total[2m])) == 0
            for: 2m
            labels:
              severity: critical
              service: ojeomneo
              category: availability
            annotations:
              summary: "Ojeomneo ì„œë¹„ìŠ¤ê°€ ë‹¤ìš´ë˜ì—ˆìŠµë‹ˆë‹¤"
              description: "Ojeomneoì—ì„œ 2ë¶„ê°„ HTTP ìš”ì²­ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì„œë¹„ìŠ¤ê°€ ë‹¤ìš´ëœ ê²ƒìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤."
              runbook_url: "https://docs.ggorockee.com/runbooks/service-down"

          # ReviewMaps Pod Restart
          - alert: ReviewMapsPodRestarting
            expr: |
              rate(kube_pod_container_status_restarts_total{namespace="reviewmaps"}[15m]) > 0
            for: 5m
            labels:
              severity: warning
              service: reviewmaps
              category: availability
            annotations:
              summary: "ReviewMaps Podê°€ ì¬ì‹œì‘ë˜ê³  ìˆìŠµë‹ˆë‹¤"
              description: "ReviewMaps Podê°€ ì§€ë‚œ 15ë¶„ê°„ ì¬ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ì•ˆì •ì„± ë¬¸ì œê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
              runbook_url: "https://docs.ggorockee.com/runbooks/pod-restarts"

          # Ojeomneo Pod Restart
          - alert: OjeomneoPlatformPodRestarting
            expr: |
              rate(kube_pod_container_status_restarts_total{namespace="ojeomneo"}[15m]) > 0
            for: 5m
            labels:
              severity: warning
              service: ojeomneo
              category: availability
            annotations:
              summary: "Ojeomneo Podê°€ ì¬ì‹œì‘ë˜ê³  ìˆìŠµë‹ˆë‹¤"
              description: "Ojeomneo Podê°€ ì§€ë‚œ 15ë¶„ê°„ ì¬ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ì•ˆì •ì„± ë¬¸ì œê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
              runbook_url: "https://docs.ggorockee.com/runbooks/pod-restarts"
