# Custom ArgoCD values for GKE with Istio and ExternalSecrets
# This file overrides the default values.yaml

global:
  domain: argocd.ggorockee.com

# ExternalSecrets configuration for Dex credentials
externalSecrets:
  dex:
    enabled: true
    # ClusterSecretStore 이름 (External Secrets Operator에서 생성됨)
    secretStore: gcpsm-secret-store
    secretStoreKind: ClusterSecretStore
    # GCP Secret Manager의 시크릿 이름
    secretKey: prod-argocd-dex-credentials
    # 생성될 Kubernetes Secret 이름 (ArgoCD가 참조)
    targetSecretName: argocd-secret
    # Merge: 기존 argocd-secret에 병합 (ArgoCD Helm이 생성한 Secret 유지)
    creationPolicy: Merge

# ArgoCD configuration
configs:
  # ConfigMap for ArgoCD settings
  cm:
    # Dex OAuth configuration
    # Secret Manager의 prod-argocd-dex-credentials에서 자동으로 주입됨
    # JSON 구조: {"google.clientId": "...", "google.clientSecret": "..."}
    dex.config: |
      connectors:
        - type: google
          id: google
          name: Google
          config:
            # ExternalSecret이 argocd-secret에 google.clientId 키로 주입
            clientID: $argocd-secret:google.clientId
            # ExternalSecret이 argocd-secret에 google.clientSecret 키로 주입
            clientSecret: $argocd-secret:google.clientSecret
            redirectURI: https://argocd.ggorockee.com/api/dex/callback
            hostedDomains:
              - gmail.com
            # Prompt을 항상 표시하여 계정 선택 가능하게 설정
            prompt: select_account

  # RBAC policy
  rbac:
    # RBAC policy 정의 (관리자 권한)
    policy.csv: |
      g, woohaen88@gmail.com, role:admin
      g, woohalabs@gmail.com, role:admin
      g, ggorockee@gmail.com, role:admin
    # 기본 정책: 인증된 사용자는 읽기 전용
    policy.default: role:readonly
    # OIDC 스코프 설정
    scopes: '[groups, email]'

  # Command parameters
  params:
    # Istio Gateway에서 TLS 처리하므로 insecure 모드
    server.insecure: true

# Server configuration
server:
  # Service type: Istio를 통한 접근이므로 ClusterIP
  service:
    type: ClusterIP

  # Insecure mode (TLS는 Istio Gateway에서 처리)
  extraArgs:
    - --insecure

  # Ingress 비활성화 (Istio VirtualService 사용)
  ingress:
    enabled: false

  # GKE Workload Identity annotation
  serviceAccount:
    create: true
    name: argocd-server
    annotations:
      iam.gke.io/gcp-service-account: argocd-prod@infra-480802.iam.gserviceaccount.com

# Dex configuration
dex:
  enabled: true
  name: dex-server

  # Dex 메트릭
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true

# Redis configuration (ArgoCD 내장 Redis 사용)
redis:
  enabled: true
  name: redis

# Redis HA 비활성화
redis-ha:
  enabled: false

# Application Controller
controller:
  name: application-controller
  replicas: 1

# Repo Server
repoServer:
  name: repo-server
  replicas: 1

# ApplicationSet Controller
applicationSet:
  enabled: true
  name: applicationset-controller
  replicas: 1

# Notifications Controller
notifications:
  enabled: true
  name: notifications-controller
