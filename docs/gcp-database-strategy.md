# GCP 데이터베이스 전략: Cloud SQL vs 로컬 VM

## 현재 상황 분석

**현재 구성**: 로컬 VM PostgreSQL (K8s 클러스터 내부)

**데이터 규모**:
- 총 레코드 수: 50,000 ~ 70,000건 (안정적 유지)
- 일일 업데이트: 4,000건
- 데이터 증가 패턴: **테이블 삭제/수정으로 총량 일정 유지**
- 데이터 특성: 갱신(UPDATE/DELETE) 중심, 순증가 없음

**데이터 용량 추정**:
- 평균 레코드 크기 1KB 가정: 50~70MB
- 인덱스 포함: 약 150~200MB
- **장기 예상**: 데이터 크기 거의 일정 유지 (150~300MB 범위)

**보안 이슈** (중요):
- **브루트 포스 공격 다발**: 외부에서 DB 접근 시도 증가
- K8s 내부 VM으로 일부 노출 가능성
- 현재 보안 조치 필요 (방화벽, IP 화이트리스트)

## Cloud SQL vs 로컬 VM 비교

### 1. 비용 분석

#### 로컬 VM (현재)

**직접 비용**:
- 전기세: 월 $10~20 (24시간 가동 시)
- 하드웨어 감가상각: 월 $15~30 (3년 사용 가정)
- **월 총 비용: $25~50**

**간접 비용**:
- 관리 시간: 월 2~4시간 (백업, 모니터링, 업데이트)
- 다운타임 리스크: 복구 시간 비용
- 백업 스토리지: 별도 구성 필요

#### Cloud SQL (GCP 옵션별)

**옵션 1: db-f1-micro (최소 스펙)**
- vCPU: 공유 1개
- RAM: 0.6GB
- 스토리지: 10GB SSD
- **월 비용: 약 $7~10** (HA 미사용)
- **제한사항**: 성능 제한, 프로덕션 비권장

**옵션 2: db-g1-small (소규모 권장)**
- vCPU: 공유 1개
- RAM: 1.7GB
- 스토리지: 10GB SSD
- **월 비용: 약 $25~35** (HA 미사용)
- **적합성**: 현재 데이터 규모에 충분

**옵션 3: db-custom-1-3840 (안정적 운영)**
- vCPU: 1개
- RAM: 3.75GB
- 스토리지: 20GB SSD
- **월 비용: 약 $50~70** (HA 미사용)
- **적합성**: 성능 여유 있음

**옵션 4: db-custom-2-4096 (고가용성 포함)**
- vCPU: 2개
- RAM: 4GB
- 스토리지: 20GB SSD
- High Availability (HA): 활성화
- **월 비용: 약 $150~200**
- **적합성**: 프로덕션 미션 크리티컬

### 2. 성능 비교

| 측면 | 로컬 VM | Cloud SQL (db-g1-small) | Cloud SQL (db-custom-2-4096) |
|-----|---------|------------------------|----------------------------|
| 읽기 성능 | 로컬 네트워크 (빠름) | Private IP 사용 시 유사 | Private IP 사용 시 유사 |
| 쓰기 성능 | 좋음 | 좋음 | 매우 좋음 |
| 동시 연결 | 설정에 따름 | 제한적 | 높음 (250+) |
| 스토리지 IOPS | HDD/SSD 따름 | 3,000 IOPS | 15,000+ IOPS |
| 보안 | 수동 설정 필요 | 자동 보안 패치 + 격리 | 자동 보안 패치 + 격리 |

### 3. 관리 복잡도 및 보안

| 작업 | 로컬 VM | Cloud SQL |
|-----|---------|-----------|
| 백업 | 수동 스크립트 필요 | 자동 (일일/주간) |
| 복구 | 수동 복원 절차 | 원클릭 복원 |
| 업그레이드 | 다운타임 필요 | 무중단 업그레이드 |
| 모니터링 | 별도 도구 설치 | Cloud Monitoring 통합 |
| 패치 | 수동 적용 | 자동 보안 패치 |
| 고가용성 | 복잡한 설정 (Replication) | HA 옵션 활성화 |
| 재해 복구 | 별도 백업 장소 필요 | 자동 지역 복제 가능 |
| **보안 관리** | **수동 방화벽 설정** | **자동 네트워크 격리** |
| **브루트 포스 방어** | **수동 fail2ban 설정** | **자동 IP 차단 + 로깅** |
| **접근 제어** | **수동 pg_hba.conf** | **IAM + Private IP** |

### 4. 데이터 안정성 시나리오

**데이터 특성**: 삭제/수정 중심, 총량 일정 유지

**장기 데이터 규모 (변화 없음)**:
- 레코드 수: 50,000 ~ 70,000건 (계속 유지)
- 데이터 크기: 150~300MB (거의 일정)
- 스토리지 요구: 10GB SSD면 충분 (여유 30배)

**VACUUM 및 유지보수 고려**:
- 삭제/수정 작업으로 Dead Tuple 증가 가능
- 정기적 VACUUM 필요 (자동 또는 수동)
- Cloud SQL: Auto VACUUM 자동 관리
- 로컬 VM: 수동 스케줄링 필요

**비용 변화** (데이터 크기 일정으로 스토리지 비용 변동 없음):

| 시점 | 로컬 VM | Cloud SQL (db-g1-small) | Cloud SQL (db-custom-2-4096) |
|-----|---------|------------------------|----------------------------|
| 현재 | $25~50 | $30 (10GB) | $160 (20GB) |
| 1년 후 | $25~50 | $30 (10GB, 변동 없음) | $160 (변동 없음) |
| 3년 후 | $25~50 | $30 (10GB, 변동 없음) | $160 (변동 없음) |

## 권장 전략

### 시나리오 1: 비용 최우선 (현 상태 유지)

**선택**: 로컬 VM PostgreSQL 유지

**조건**:
- 데이터 중요도가 중간 정도
- 몇 시간의 다운타임 허용 가능
- 개발자가 DB 관리 가능

**개선 사항**:
- 자동 백업 스크립트 구성
- Cloud Storage에 백업 저장 (월 $1~2)
- 모니터링 도구 설치 (Prometheus + Grafana)

**총 비용**: 월 $30~55

### 시나리오 2: 하이브리드 전략 (권장)

**선택**: 환경별 분리

**구성**:
- **개발/테스트**: 로컬 VM PostgreSQL
- **프로덕션**: Cloud SQL db-g1-small

**장점**:
- 개발 비용 절감
- 프로덕션 안정성 확보
- 프로덕션 데이터 자동 백업

**총 비용**:
- 로컬 VM (dev): $30
- Cloud SQL (prod): $35
- **합계: 월 $65**

### 시나리오 3: 완전 마이그레이션 (안정성 우선)

**선택**: 모든 환경을 Cloud SQL로 전환

**구성**:
- **개발**: Cloud SQL db-f1-micro ($10)
- **프로덕션**: Cloud SQL db-custom-2-4096 + HA ($180)

**장점**:
- 완전한 관리형 서비스
- 고가용성 보장
- 재해 복구 자동화
- 개발자 DB 관리 부담 제거

**총 비용**: 월 $190

### 시나리오 4: 점진적 마이그레이션 (최적 균형)

**선택**: 로컬 VM + Cloud SQL 하이브리드

**단계별 전환**:

**Phase 1 (현재~3개월)**:
- 로컬 VM 유지
- Cloud SQL db-g1-small을 테스트 환경으로 사용
- 백업은 Cloud Storage에 저장
- **비용: 월 $35**

**Phase 2 (3~6개월)**:
- 프로덕션을 Cloud SQL db-g1-small로 마이그레이션
- 로컬 VM은 개발 환경으로 전환
- **비용: 월 $65**

**Phase 3 (6개월~1년)**:
- 트래픽 증가 시 db-custom-1-3840으로 업그레이드
- **비용: 월 $80**

**Phase 4 (1년 이후)**:
- HA 활성화 검토 (비즈니스 중요도에 따라)
- **비용: 월 $100~180**

## 의사결정 가이드

### Cloud SQL 선택 기준

**다음 중 2개 이상 해당 시 Cloud SQL 권장**:
- ✅ 데이터 손실 시 비즈니스 영향 큼
- ✅ 24/7 가용성 필요
- ✅ DB 관리에 시간 투자 어려움
- ✅ 자동 백업/복구 필요
- ✅ 확장성 중요 (데이터 증가 예상)
- ✅ 보안 컴플라이언스 필요

### 로컬 VM 유지 기준

**다음 중 3개 이상 해당 시 로컬 VM 유지**:
- ✅ 비용이 최우선 고려사항
- ✅ 데이터 규모 작음 (<10GB)
- ✅ 다운타임 수 시간 허용 가능
- ✅ DB 관리 역량 보유
- ✅ 인터넷 지연 민감 (로컬 네트워크 성능 중요)

## 마이그레이션 전략 (Cloud SQL 선택 시)

### 1. 사전 준비
- Cloud SQL 인스턴스 생성 (테스트용)
- 데이터 덤프 생성: `pg_dump`
- 네트워크 연결 테스트

### 2. 데이터 마이그레이션
- 덤프 파일을 Cloud Storage에 업로드
- Cloud SQL로 임포트
- 데이터 무결성 검증

### 3. 애플리케이션 전환
- 연결 문자열 변경 (환경 변수)
- Private IP 사용 (GKE와 동일 VPC)
- 연결 풀링 설정 (PgBouncer 또는 Cloud SQL Proxy)

### 4. 모니터링 및 최적화
- Cloud Monitoring 알림 설정
- 쿼리 성능 모니터링
- 느린 쿼리 최적화

## 비용 최적화 팁

### Cloud SQL 사용 시
1. **개발 환경은 자동 종료**: 업무 시간 외 인스턴스 중지
2. **스토리지 자동 증가 설정**: 필요할 때만 확장
3. **백업 보존 기간 최소화**: 7일 권장 (기본 30일)
4. **리전 선택**: `asia-northeast3` (서울) 또는 `asia-northeast1` (도쿄)
5. **Reserved Instances 검토**: 1년 약정 시 25% 할인

### 하이브리드 전략
1. **읽기 전용 복제본**: Cloud SQL Read Replica (필요시)
2. **캐싱 레이어**: Redis/Memcached로 DB 부하 감소
3. **연결 풀링**: 동시 연결 수 최소화

## 최종 권장안

**현재 상황 (5~7만건 유지, 일 4천건 갱신, 브루트 포스 공격 다발) 기준**:

### 🔴 추천 1순위: Cloud SQL 전환 (보안 + 안정성 우선) - **변경됨**
- **구성**: Cloud SQL db-g1-small (Private IP)
- **총 비용**: 월 $30 (10GB)
- **장점**:
  - **브루트 포스 방어**: 자동 IP 차단 + Cloud Armor 연동 가능
  - **Private IP 전용**: GKE와 동일 VPC, 외부 노출 차단
  - **자동 보안 패치**: PostgreSQL 취약점 자동 업데이트
  - **IAM 인증**: 비밀번호 외 추가 인증 레이어
  - **감사 로그**: 모든 DB 접근 기록 자동 수집
  - 데이터 크기 일정으로 장기 비용 안정
- **단점**:
  - 로컬 VM 대비 약간 높은 비용 ($0~5/월 차이)
- **적합**: **보안 이슈가 있는 현재 상황에 최적**

### 추천 2순위: 하이브리드 전략 (개발 비용 절감)
- **개발**: 로컬 VM ($30)
- **프로덕션**: Cloud SQL db-g1-small ($30, Private IP)
- **총 비용**: 월 $60
- **장점**:
  - 프로덕션만 보안 강화
  - 개발 환경 비용 절감
- **적합**: 개발 환경은 브루트 포스 공격 영향 없을 때

### 추천 3순위: 로컬 VM 유지 + 보안 강화
- **구성**: 로컬 VM + fail2ban + 방화벽 강화
- **총 비용**: 월 $30~35
- **필수 조치**:
  - fail2ban 설치 및 설정 (브루트 포스 IP 자동 차단)
  - PostgreSQL 포트 변경 (5432 → 비표준 포트)
  - pg_hba.conf 엄격한 IP 화이트리스트
  - 강력한 비밀번호 정책 (12자 이상, 특수문자)
  - 정기적인 보안 로그 모니터링
- **단점**:
  - **수동 관리 부담 증가**
  - 신규 공격 패턴 대응 지연
  - 관리 시간 월 4~6시간 (보안 모니터링 포함)

### 비추천: 완전 Cloud SQL (db-custom-2-4096 + HA)
- **이유**:
  - 데이터 크기 일정 (150~300MB)으로 고스펙 불필요
  - db-g1-small (1.7GB RAM)으로 충분
  - 비용 대비 효과 낮음
- **고려 시점**:
  - 동시 연결 수 급증 (100+ connections)
  - 복잡한 쿼리 증가
  - 미션 크리티컬 서비스 전환

## 브루트 포스 공격 대응 전략

### 현재 문제 상황
- K8s 내부 VM PostgreSQL에 외부 공격 시도 다발
- 공격 유형: 비밀번호 무차별 대입 (Brute Force)
- 잠재적 위험: 계정 탈취, 데이터 유출, 서비스 중단

### Cloud SQL 보안 장점

**1. Private IP 전용 연결**
- GKE와 동일 VPC 내부 통신
- 인터넷 노출 완전 차단
- Public IP 비활성화 가능

**2. VPC Service Controls**
- 데이터 경계 설정
- 승인된 네트워크만 접근
- 자동 위협 탐지

**3. Cloud Armor 연동 (선택)**
- DDoS 방어 레이어 추가
- IP 기반 접근 제어
- Rate Limiting (요청 속도 제한)

**4. Cloud Audit Logs**
- 모든 DB 접근 시도 기록
- 이상 패턴 자동 탐지
- Cloud Monitoring 알림 연동

**5. IAM Database Authentication**
- 비밀번호 외 IAM 토큰 인증
- 단기 임시 자격증명 (15분~1시간)
- 계정 탈취 리스크 최소화

### 로컬 VM 보안 강화 방법 (유지 선택 시)

**즉시 조치 사항**:

1. **fail2ban 설치 및 설정**
   - 5회 로그인 실패 시 IP 차단
   - 차단 시간: 1시간~영구
   - PostgreSQL 로그 모니터링

2. **PostgreSQL 포트 변경**
   - 기본 5432 → 비표준 포트 (예: 54321)
   - 포트 스캔 공격 회피

3. **pg_hba.conf 강화**
   - 특정 IP만 허용 (화이트리스트)
   - GKE Pod CIDR만 접근 허용
   - 외부 IP 완전 차단

4. **강력한 인증 정책**
   - 비밀번호 12자 이상 + 특수문자
   - 계정별 복잡도 정책
   - 정기 비밀번호 변경 (90일)

5. **연결 제한**
   - max_connections 제한
   - connection_limit per user
   - idle_in_transaction_session_timeout 설정

6. **로그 모니터링**
   - 로그인 실패 패턴 감시
   - 비정상 쿼리 탐지
   - 일일 보안 리포트

**예상 관리 시간**:
- 초기 설정: 4~6시간
- 주간 모니터링: 1~2시간
- 월간 유지보수: 4~6시간
- **총 월 4~6시간 추가 투입**

### 보안 비용 비교

| 항목 | 로컬 VM + 보안 강화 | Cloud SQL Private IP |
|-----|-------------------|---------------------|
| 인프라 비용 | $30/월 | $30/월 |
| 관리 시간 비용 | 월 4~6시간 ($80~120) | 0시간 (자동화) |
| 보안 도구 | fail2ban (무료) | 내장 (무료) |
| 감사 로그 | 수동 분석 | 자동 수집 + 분석 |
| **총 비용 (시간 포함)** | **$110~150/월** | **$30/월** |

### 권장 마이그레이션 계획 (보안 우선)

**Phase 1 (1주차): 긴급 보안 조치**
- Cloud SQL db-g1-small 인스턴스 생성 (Private IP)
- 데이터 덤프 및 마이그레이션 준비

**Phase 2 (2주차): 테스트 마이그레이션**
- 개발 환경 먼저 Cloud SQL로 전환
- 연결 테스트 및 성능 검증
- 애플리케이션 설정 변경 (Private IP)

**Phase 3 (3주차): 프로덕션 전환**
- 다운타임 최소화 전략 (Blue-Green)
- 프로덕션 데이터 마이그레이션
- DNS/Service 전환

**Phase 4 (4주차): 검증 및 최적화**
- 보안 로그 확인 (브루트 포스 차단 검증)
- 성능 모니터링
- 로컬 VM 제거

## 의사결정 체크리스트 (브루트 포스 공격 상황 반영)

- [ ] **긴급도**: 브루트 포스 공격이 계속되고 있는가? (예/아니오)
- [ ] **보안 우선순위**: 데이터 유출 리스크 허용 불가? (예/아니오)
- [ ] **관리 시간**: 보안 모니터링에 주 1~2시간 투입 가능? (가능/불가)
- [ ] **다운타임 허용**: 마이그레이션 중 다운타임 허용 시간은? (분/시간/일)
- [ ] **데이터 손실 영향**: 비즈니스 영향도는? (낮음/중간/높음)
- [ ] **예산 제약**: 월 $30~60 예산 가능? (예/아니오)
- [ ] **기술 역량**: fail2ban, 방화벽 설정 가능? (가능/불가)

### 빠른 의사결정 가이드

**브루트 포스 공격이 심각한 경우**:
→ **Cloud SQL 즉시 전환** (추천 1순위)

**보안 관리 시간 투입 가능한 경우**:
→ **로컬 VM + 보안 강화** (추천 3순위)

**예산이 매우 제한적인 경우**:
→ **임시 보안 강화 후 점진적 Cloud SQL 전환**

## UPDATE/DELETE 중심 워크로드 최적화

### 1. VACUUM 전략

**로컬 VM 설정**:
- Auto VACUUM 활성화 (postgresql.conf)
- 야간 Full VACUUM 스케줄링
- Dead Tuple 모니터링

**Cloud SQL 장점**:
- Auto VACUUM 자동 관리
- 최적 VACUUM 스케줄 적용
- 관리 부담 없음

### 2. 인덱스 유지보수

**문제**: DELETE/UPDATE로 인덱스 bloat 발생
**해결책**:
- 주기적 REINDEX (월 1회)
- Cloud SQL: 자동 최적화
- 로컬 VM: 수동 스케줄링

### 3. 성능 모니터링

**핵심 지표**:
- Dead Tuple 비율 (<5% 권장)
- Bloat Index 크기
- VACUUM 실행 이력
- 쿼리 응답 시간

### 4. 백업 전략 (데이터 크기 일정)

**로컬 VM**:
- 일일 Full Backup (덤프 크기 ~200MB)
- Cloud Storage 저장 (월 $0.40, 200MB × $0.020/GB)
- 7일 보관 (총 1.4GB, 월 $0.03)

**Cloud SQL**:
- 자동 일일 백업 (무료, 7일 보관)
- On-demand 백업 (필요시)
- Point-in-Time Recovery (PITR)

## 다음 단계

### 긴급 컨펌 필요 사항 (브루트 포스 공격 대응)

1. **현재 보안 상황 심각도는?**
   - 경미 (가끔 공격 시도)
   - 중간 (일 수백 건 공격)
   - 심각 (초당 공격 시도, 서비스 영향)

2. **선호 전략은?**
   - Cloud SQL 즉시 전환 (보안 + 안정성, 월 $30)
   - 하이브리드 (dev 로컬 + prod Cloud SQL, 월 $60)
   - 로컬 VM 유지 + 보안 강화 (월 $30 + 관리 시간)

3. **마이그레이션 다운타임 허용은?**
   - 야간 2~4시간 가능
   - 주말 전체 가능
   - 무중단 필수 (Blue-Green)

4. **예산 상한선은?**
   - 월 $30까지 (로컬 VM 유지)
   - 월 $30~60 (Cloud SQL 가능)
   - 월 $100+ (고가용성 필요시)

### 즉시 조치 가능한 임시 보안 강화 (Cloud SQL 전환 전)

**30분 내 적용 가능**:
- PostgreSQL 포트 변경: `port = 54321`
- pg_hba.conf 화이트리스트: GKE Pod IP만 허용
- 비밀번호 복잡도 강화

**1일 내 적용 가능**:
- fail2ban 설치 및 PostgreSQL jail 설정
- 로그 모니터링 스크립트 작성
- 일일 보안 리포트 자동화
